name: Node.js CI

on:
  push:
    paths: api-service-template/**
    branches: [ "main" ]
  pull_request:
    paths: api-service-template/**
    branches: [ "main" ]

env:
  PROJECT_DIR: api-service-template

jobs:
  build:
    runs-on: ubuntu-latest

    # æˆæœç‰©ã®éšå±¤ãŒrootå‡ºãªã„å ´åˆã¯ä»¥ä¸‹ã‚’æŒ‡å®šã™ã‚‹
    defaults:
      run:
        working-directory: ${{ env.PROJECT_DIR }}
    
    steps:
    # ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆmainãƒ–ãƒ©ãƒ³ãƒå¯¾è±¡ï¼‰
    - uses: actions/checkout@v4

    # Node.js 18 ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã€npm ã®ä¾å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–
    - name: Use Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'
        cache-dependency-path: ${{ env.PROJECT_DIR }}/package-lock.json
    
    # npm ã®ä¾å­˜é–¢ä¿‚ã‚’ package-lock.json ã«å¾“ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - run: npm ci

    # OpenAPIä»•æ§˜ã‹ã‚‰å‹å®šç¾©ã‚’è‡ªå‹•ç”Ÿæˆ
    - name: Generate TypeScript types from OpenAPI
      run: |
        npm install --save-dev openapi-typescript @apidevtools/swagger-parser
        npx openapi-typescript ../openapi-api-template/openapi.yaml --output src/types.ts

    # ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚ã‚Œã°å®Ÿè¡Œï¼ˆç„¡ã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    - run: npm run build --if-present

    # Jest ã‚’ JSON å‡ºåŠ›ä»˜ãã§å®Ÿè¡Œ
    # ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã‚‚ exit 1 ã«ã›ãšå¾Œç¶šå‡¦ç†ã‚’ç¶™ç¶šï¼ˆ|| true ã«ã‚ˆã‚Šå¼·åˆ¶æˆåŠŸæ‰±ã„ï¼‰
    - name: Run Jest with JSON output
      run: npx jest --json --outputFile=jest-results.json || true

    # å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã€GitHub Actions ã®ãƒ­ã‚°ã«è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›
    - name: Warn if tests failed
      run: |
        FAILED=$(jq '.numFailedTests' jest-results.json)
        if [ "$FAILED" -gt 0 ]; then
          echo "::warning::There are $FAILED failed test(s)."
        fi

    # Jest ã®å‡ºåŠ›ï¼ˆjest-results.jsonï¼‰ã‹ã‚‰å¤±æ•—ãƒ†ã‚¹ãƒˆæƒ…å ±ã‚’æŠ½å‡ºã— Markdown ã‚’ç”Ÿæˆ
    - name: Show test summary in job summary
      id: summary
      run: |
        if [ $(jq '.numFailedTests' jest-results.json) -eq 0 ]; then
          echo "All tests passed! ğŸ‰" > result.md
        else
          # Markdown ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨˜è¿°
          echo "## âŒ Failed Tests" > result.md
          echo "| Suite (Describe) | Test Name | File:Line |" >> result.md
          echo "| ---------------- | --------- | --------- |" >> result.md

          # å¤±æ•—ãƒ†ã‚¹ãƒˆ1ä»¶ãšã¤å‡¦ç†
          jq -c '
            .testResults[]
            | .testFilePath as $file
            | .assertionResults[]
            | select(.status=="failed")
            | {
                suite: (.ancestorTitles | join(" > ")),
                name: .fullName,
                message: (.failureMessages | join("\n"))
              }
          ' jest-results.json | while read -r row; do
            # å„é …ç›®ã‚’æŠ½å‡º
            suite=$(echo "$row" | jq -r '.suite')
            name=$(echo "$row" | jq -r '.name')
            message=$(echo "$row" | jq -r '.message')

            # ãƒ•ãƒ«ãƒ‘ã‚¹ä¸­ã® ts ãƒ•ã‚¡ã‚¤ãƒ«ä½ç½®ã‚’æŠ½å‡ºï¼ˆæ‹¬å¼§ã‚’é™¤å»ï¼‰
            loc=$(echo "$message" | grep -Eo '[^ ]+\.ts:[0-9]+:[0-9]+' | head -n 1 | sed 's/[()]//g')
            
            # ãƒ•ãƒ«ãƒ‘ã‚¹ â†’ ç›¸å¯¾ãƒ‘ã‚¹ã«å¤‰æ›ï¼ˆGITHUB_WORKSPACE ã‚’é™¤å»ï¼‰
            if [ -n "$loc" ]; then
              loc=$(echo "$loc" | sed "s|$GITHUB_WORKSPACE/||")
            else
              loc="ï¼ˆä½ç½®æƒ…å ±ãªã—ï¼‰"
            fi

            # ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã¨ã—ã¦å‡ºåŠ›
            printf "| %s | %s | %s |\n" "$suite" "$name" "$loc" >> result.md
          done

          # ãƒ†ãƒ¼ãƒ–ãƒ«ä¸‹éƒ¨ã«æ³¨é‡ˆã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
          echo "" >> result.md
          echo "> â€» File:Lineåˆ—ã¯ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ä¸Šã®ç›¸å¯¾ãƒ‘ã‚¹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«:è¡Œ:åˆ—ï¼‰ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚" >> result.md
          echo "> Jestã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æŠ½å‡ºã—ã¦ã„ã‚‹ãŸã‚ã€æ­£ç¢ºãªä½ç½®ãŒå¾—ã‚‰ã‚Œãªã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚" >> result.md
        fi

        # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã¸ã®å‡ºåŠ›å¤‰æ•°ã¨ã—ã¦ result.md ã®ãƒ‘ã‚¹ã‚’æŒ‡å®š
        echo "summary_file=result.md" >> $GITHUB_OUTPUT

    # ç”Ÿæˆã—ãŸ Markdown ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜ï¼ˆå¿…è¦ã«å¿œã˜ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ï¼‰
    - name: Upload job summary
      uses: actions/upload-artifact@v4
      with:
        name: jest-summary
        path: ${{ env.PROJECT_DIR }}/result.md

    # GitHub Actions ã® UI ä¸Šã« Markdown ã®å†…å®¹ã‚’ã‚¸ãƒ§ãƒ–ã‚µãƒãƒªãƒ¼ã¨ã—ã¦è¡¨ç¤º
    - name: Add job summary markdown to GitHub UI
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('${{ env.PROJECT_DIR }}/result.md', 'utf8');
          core.summary.addRaw(summary).write();
